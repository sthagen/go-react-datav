---
title: 告警和通知
---

import { Heading } from '@/components/Heading'
import { List, ListItemBad } from '@/components/List'
import Link from 'next/link'
import stats from '@/utils/stats'
import { TipCompat } from '@/components/Tip'

告警是Datav内置的强大功能，目前只支持Graph图表。


## 告警通知
当告警状态发生变化时，系统会发送告警通知到指定的用户通道。每个团队都可以创建和管理自己的告警通道,下面我们以global团队为例来进行介绍。

在创建告警通道前，**有一个非常重要的配置要完成**：邮件SMTP设置，进入datav的安装目录，打开`datav.conf`文件，找到`smtp`区域，然后进行设置。

### 创建告警通道
1. 在侧边菜单选择**配置管理 -> 团队 -> 查看global -> 告警通道 -> 新建通道**
2. 输入名称，类型选择email，在地址栏输入推送的目标邮件地址，用`;`分割
3. 当`设为默认`开启后，该团队所有告警都会默认给当前的通道推送一次通知；当`忽略告警回复`开启后，只会推送告警触发的通知，而不会推送告警恢复的通知
4. 点击测试，我们会给你设置的邮件地址发送测试邮件
5. 点击保存

### 管理告警通道
1. 在侧边菜单选择**配置管理 -> 团队 -> 查看global -> 告警通道**
2. 点击表格对应的行，弹出面板，进行编辑


## 告警规则
告警规则用于控制告警的触发条件和规则，它是跟仪表盘的图表绑定在一起的，**因此，当你删除图表时，也会同时删除相应的告警规则**。

在创建告警规则前，我们需要在global团队下有一个仪表盘，如果没有，请新建仪表盘。
### 创建规则
1. 进入global团队的仪表盘，创建一个graph图表，使用prometheus数据源或者测试数据来生成图表曲线
2. 进入图表编辑页面，选择左下方的**告警标签页**，点击创建告警

这个页面较为复杂，下面我们来一一进行讲解：
- 名称 : 给告警起一个贴切的名称，方便后面的索引管理
- 求值间隔 + 持续：Datav会每隔X分钟查询一次数据，然后根据`告警阈值 & 条件`判断是否达到告警阈值，如果达到阈值，则将当前状态从`OK`更改为`PENDING`，当`PENDING`状态
持续超过Y分钟后，就会进行告警推送
- 告警阈值 &条件： 当(When)查询语句A的(OF QUERY A)平均值(avg)符合某个条件(WITH LABELS AND VALUES)且持续时间超过5分钟(LAST 5m)时，则达到告警阈值，将当前状态设置为Pending状态。
<TipCompat>Grafana的告警粒度是图表级别，就算图表有1000个曲线，也只有一个曲线可以告警，因此在多曲线的时候，grafana的告警会变得极其不好用。
与之相比，Datav的告警粒度是图表中的每条曲线</TipCompat> 
点击WITH LABELS AND VALUES，可以根据标签对图表中的曲线进行过滤，默认是_Default，表示图表中的所有曲线都使用该条件。
例如有以下图表: <img class="block mx-auto sm:mx-0 sm:flex-shrink-0 h-96" src="/img/docs/alerts-1.jpg" alt="Image" />
现在，我们想为标签instance=10.77.0.130:8199这条曲线设置告警阈值`0.2`,为其它曲线设置告警阈值`0.01`，可以进行如下设置：
<img class="block mx-auto sm:mx-0 sm:flex-shrink-0 h-96" src="/img/docs/alerts-2.jpg" alt="Image" />

- 推送通道：`正常通道`就是之前我们创建的告警通道，对所有曲线都有效，而`设置特例`可以针对曲线级别进行单独设置，让某条曲线推送到特例的通道中。
- 消息内容: 在告警内容中进行补充，你也可以添加KV对，作为标签来进行搜索

## 全局告警管理
在侧边菜单栏下方点击**告图标**，进入告警管理页面。在这里，用户可以对告警进行统一的管理，而不用手动进入某个仪表盘进行设置。

### 告警规则
在该页面可以看到我们已经设定好的规则，规则名称旁边还用括号注明了所属的团队，点击规则名称可以前往规则编辑页面，点击团队名称可以前往团队页面。

### 告警历史
在该页面可以看到历史发生过的告警推送，点击推送行，可以前往当时的现场快照，方便用户快速查看问题发生的现场



